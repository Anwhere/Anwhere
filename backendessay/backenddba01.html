<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="Anwhere">
  <meta name="keyword" content="Anwhere, Studio,Bootstrap, Admin, Template, Theme, Responsive, Fluid, Retina">
  <title>Anwhere Studio</title>

  <!-- Favicons -->
  <link href="../img/favicon.png" rel="icon">
  <link href="../img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Bootstrap core CSS -->
  <link href="../lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <!--external css-->
  <link href="../lib/font-awesome/css/font-awesome.css" rel="stylesheet" />
  <link rel="stylesheet" type="text/css" href="../lib/gritter/css/jquery.gritter.css" />
  <!-- Custom styles for this template -->
  <link href="../css/style.css" rel="stylesheet">
  <link href="../css/style-responsive.css" rel="stylesheet">

  <!-- =======================================================
    Web work Name: Anwhere
    Template URL: https://
    Author: Anwhere.Jin
    License: https://
  ======================================================= -->
</head>

<body>
  <section id="container">
    <!-- **********************************************************************************************************************************************************
        TOP BAR CONTENT & NOTIFICATIONS
        *********************************************************************************************************************************************************** -->
    <!--header start-->
    <header class="header black-bg">
      <div class="sidebar-toggle-box">
        <div class="fa fa-bars tooltips" data-placement="right" data-original-title="Toggle Navigation"></div>
      </div>
      <!--logo start-->
      <a href="../index.html" class="logo"><b><span>AN</span>WHERE</b></a>
      <!--logo end-->
      
      </div>
      <div class="top-menu">
        
      </div>
    </header>
    <!--header end-->
    <!-- **********************************************************************************************************************************************************
        MAIN SIDEBAR MENU
        *********************************************************************************************************************************************************** -->
    <!--sidebar start-->
    <aside>
      <div id="sidebar" class="nav-collapse ">
        <!-- sidebar menu start-->
        <ul class="sidebar-menu" id="nav-accordion">
          <p class="centered"><a href="#"><img src="../img/mainphoto.jpg" class="img-circle" width="80"></a></p>
          <h5 class="centered">Anwhere Jin</h5>
          <li class="mt">
            <a href="../index.html">
              <i class="fa fa-dashboard"></i>
              <span>首页</span>
              </a>
          </li>
          <li class="sub-menu">
            <a class="active" href="javascript:;">
              <i class="fa fa-desktop"></i>
              <span>任务Review</span>
              </a>
            <ul class="sub">
              <li><a href="../general.html">Visualization</a></li>
              <li><a href="../valuable.html">Valuable</a></li>
              <li><a href="../frontend.html">Frontend</a></li>
              <li class="active"><a href="../backend.html">Backend</a></li>
            </ul>
          </li>
          <li class="sub-menu">
            <a href="javascript:;">
              <i class="fa fa-leaf"></i>
              <span>事件Events</span>
              </a>
            <ul class="sub">
              <li><a href="#">Blank01</a></li>
              <li><a href="#">Blank02</a></li>
              <li><a href="#">Blank03</a></li>
              <li><a href="#">Blank04</a></li>
              <li><a href="#">Blank05</a></li>
              <li><a href="#">Blank06</a></li>
              <li><a href="#">Blank07</a></li>
            </ul>
          </li>
          <li class="sub-menu">
            <a href="javascript:;">
              <i class="fa fa-book"></i>
              <span>相关文档</span>
              </a>
            <ul class="sub">
              <li><a href="#">Blank01</a></li>
              <li><a href="#">Blank02</a></li>
              <li><a href="#">Blank03</a></li>
              <li><a href="#">Blank04</a></li>
              <li><a href="#">Blank05</a></li>
              <li><a href="#">Blank06</a></li>
              <li><a href="#">Blank07</a></li>
              <li><a href="#">Blank08</a></li>
              <li><a href="#">Blank09</a></li>
            </ul>
          </li>
          <li class="sub-menu">
            <a href="javascript:;">
              <i class="fa fa-star-half-o"></i>
              <span>介绍</span>
              </a>
            <ul class="sub">
              <li><a href="#">Blank01</a></li>
              <li><a href="#">Blank02</a></li>
              <li><a href="#">Blank03</a></li>
            </ul>
          </li>
          <li class="sub-menu">
            <a href="javascript:;">
              <i class="fa fa-envelope"></i>
              <span>联系我们</span>
              </a>
            <ul class="sub">
              <li><a href="../email.html">Email</a></li>
              <li><a href="#">Blank02</a></li>
              <li><a href="#">Blank03</a></li>
            </ul>
          </li>
        </ul>
        <!-- sidebar menu end-->
      </div>
    </aside>
    <!--sidebar end-->
    <!-- **********************************************************************************************************************************************************
        MAIN CONTENT
        *********************************************************************************************************************************************************** -->
    <!--main content start-->
    <section id="main-content">
      <section class="wrapper">
      <div class="row content-blog">
          <div class="col-lg-10 col-lg-offset-1">
            <div class="row">
              <div class="col-md-6 mt">
                <img src="../img/backend/dba02.jpg" class="img-responsive">
                <h3>Oracle DBA 操作总结<br>Oracle &amp; Backend</h3>
                <hr>
                <h5>By Anwhere Jin. <span>Date issued : 24-12-2018.</span></h5>

                <p class="mt">
                  很多大型的开发项目或者数据量特别大的需求，都会采用Oracle数据库存储技术，而涉及到的数据库操作可能需要你掌握相关的DBA操作，实际上也就是分析数据存储原理，入库出库系统，常用的查询和修改操作。
                </p><br>
                <h4>· 01>>> 查询和建立DBLink</h4> 
                <p class="mt">
                  <p class="mmt">查询dblink的语言为：</p>
                  <code>select * from dba_db_links;</code>
                  <p class="mmt">删除dblink（原dblink名称uat5link2）：</p>
                  <code>drop database link UAT5LINK2;</code>
                  <p class="mmt">建立dblink</p>
                  <pre>
create public database link UALINK connect to uat5link2 identified by "uat5link2pwd" USING '
  (DESCRIPTION = (ADDRESS_LIST = (ADDRESS = (PROTOCOL = TCP)
  (HOST =  10.*.**.**)
  (PORT = 1521)))
  (CONNECT_DATA = (SERVICE_NAME = *******)
    )
 )';</pre>
                </p><br>
                <h4>· 02>>> 创建Job定时任务</h4> 
                <p class="mt">
                  <p class="mmt">为了让数据库批处理任务在指定时间定时运行，可以使用Job定时任务</p>
                  <pre>
declare
  job number;
BEGIN
  DBMS_JOB.SUBMIT(  
        JOB => job,  /*自动生成JOB_ID*/  
        WHAT => 'PROC_GP_TEST;',  /*需要执行的存储过程名称或SQL语句*/  
        NEXT_DATE => sysdate+3/(24*60) ,  /*初次执行时间-下一个3分钟*/  
        INTERVAL => 'TRUNC(SYSDATE + 1)' /*每隔1分钟执行一次*/
      );  
  commit;
end;</pre>
                </p><br>
                <h4>· 03>>> 查询表空间容量 </h4> 
                <p class="mt">
                  <p class="mmt">oracle数据库会给所有用户分配存储空间，当达到表空间容量后便无法进行数据插入等操作。</p>
                  <p class="mmt">查询表空间容量的语句有： </p>
                  <code>SELECT * FROM dba_data_files WHERE tablespace_name = 'table_a';</code>
                  <pre>select tablespace_name, file_id, file_name,
round(bytes/(1024*1024),0) total_space
from dba_data_files
order by tablespace_name;</pre>
                  <pre>SELECT a.tablespace_name "表空间名",
       total "表空间大小",
       free "表空间剩余大小",
       (total - free) "表空间使用大小",
       total / (1024 * 1024 * 1024) "表空间大小(G)",
       free / (1024 * 1024 * 1024) "表空间剩余大小(G)",
       (total - free) / (1024 * 1024 * 1024) "表空间使用大小(G)",
       round((total - free) / total, 4) * 100 "使用率 %"
  FROM (SELECT tablespace_name, SUM(bytes) free
          FROM dba_free_space
         GROUP BY tablespace_name) a,
       (SELECT tablespace_name, SUM(bytes) total
          FROM dba_data_files
         GROUP BY tablespace_name) b
 WHERE a.tablespace_name = b.tablespace_name;</pre>
                  <p class="mmt">增加表空间容量【需要DBA权限】</p>
                  <code>alter database datafile '/u2/oracle/PLM_SD_data' resize 3000m;</code>
                </p><br>

                <h4>· 04>>> 查询执行最慢的SQL </h4> 
                <p class="mt">
                  <p class="mmt">有时候我们也会碰到存储过程执行的非常缓慢，为了找到具体是哪条SQL有问题，也方便后续进行优化操作，需要找到那些执行最慢的SQL语句，下面找到平均执行时间最长的50条SQL</p>
                  <pre>select *
  from (select sa.SQL_TEXT,             
               sa.SQL_FULLTEXT,               
               sa.EXECUTIONS "执行次数",              
               round(sa.ELAPSED_TIME / 1000000, 2) "总执行时间",        
               round(sa.ELAPSED_TIME / 1000000 / sa.EXECUTIONS, 2) "平均执行时间",     
               sa.COMMAND_TYPE,        
               sa.PARSING_USER_ID "用户ID",          
               u.username "用户名",         
               sa.HASH_VALUE  
          from v$sqlarea sa   
          left join all_users u 
            on sa.PARSING_USER_ID = u.user_id 
         where sa.EXECUTIONS > 0   
         order by (sa.ELAPSED_TIME / sa.EXECUTIONS) desc)
 where rownum <= 50;</pre>
                </p><br>

                <h4>· 05>>> 查询事务锁</h4>
                <p class="mt">
                  <p class="mmt">有时候我们可能都无法成功执行数据操作，也可能会提醒该表正在使用而实际上没有任何人对其进行操作，可能是事务被锁住了</p>
                  <p class="mmt">查询事务锁的语句</p>
                  <pre>select t2.username, t2.sid, t2.serial#, t2.logon_time
  from v$locked_object t1, v$session t2
 where t1.session_id = t2.sid
 order by t2.logon_time;

select sql_text
  from v$session a, v$sqltext_with_newlines b
 where DECODE(a.sql_hash_value, 0, prev_hash_value, sql_hash_value) =
       b.hash_value
   and a.sid = &sid
 order by piece;</pre>
                <p class="mmt">Kill 事务锁 【需要DBA权限】</p>
                <code>alter system kill session '126,46707';</code>
                </p><br>

                <h4>· 06>>> 同库数据迁移 | 导入Dmp文件</h4> 
              <p class="mt">
                  <p class="mmt">a) 查询用户进程，并杀掉</p>
                  <code>select username,serial#, sid from v$session where username = 'KIS_SIT';</code><br>
                  <code>select 'ALTER SYSTEM KILL SESSION '''||sid||','||serial#||''';' from v$session where username = 'KIS_SIT';</code>
                  <p class="mmt">b) 删除用户</p>
                  <code>drop user kis_sit cascade;</code>
                  <p class="mmt">c) 删除表空间</p>
                  <code>DROP TABLESPACE kis_sit INCLUDING CONTENTS AND DATAFILES;</code>
                  <p class="mmt">d) 创建表空间</p>
                  <code>create tablespace kis_sit datafile'/u01/app/oracle/oradata/kisdb/kis_sit201812.dbf' size 200M autoextend on;</code>
                  <p class="mmt">e) 创建用户</p>
                  <code>create user kis_sit identified by kis_sit default tablespace kis_sit temporary tablespace TEMP profile DEFAULT quota unlimited on kis_sit;</code>
                  <p class="mmt">最后一个‘kis_sit’指表空间</p>
                  <p class="mmt">f) 授权</p>
                  <code>grant connect,resource,dba to kis_sit ;</code><br>
                  <code>grant create view to kis_sit; </code>
                  <p class="mmt">g) 导入dmp文件</p>
                  <code>imp kis_sit/kis_sit@KIS_DEV file=G:\oracle_dmp_file\IMP_KIS_LC\20181222_kissuat.dmp fromuser=kis_uat touser=kis_sit </code>
              </p>



              </div>

            <div class="col-md-6 mt">
              <h4>· 07>>> 数据迁移</h4> 
              <p class="mt">
                <h6> 一、迁移方案</h6>
                <p class="mmt">oracle表数据导出成csv，再把csv导入到mysql数据库；</p>
                <h6> 二、oracle表数据导出成csv</h6>
                <p class="mmt">1、spool</p>
                <p class="mmt"> spool工具在sqlplus中随时可以使用，较为灵活，通过sqlplus的格式设置处理，字段分割利用sql语句拼成，能迅速导出一些小数据量的需求。因为是配合sqlplus，它可以支持本地和客户端的数据导出，但是效率不高。</p>
                <p class="mmt">2、plsql-developer</p>
                <p class="mmt">plsql-developer工具只是个代表，还有很多工具可以连接数据库，进行导出操作，从交互配置中完成需要导出的数据设置。它也可以支持本地和客户端的数据导出，效率高于spool。</p>
                <p class="mmt">3、utl_file方法</p>
                <p class="mmt">utl_file方法是oracle提供的文件读写包，该方法需要一定的编写存储过程和sql的能力，而且需要指定读写路径，因此只能在服务器本地生成文件，若大量导出，还需要完成文件的传输。</p>
                <p class="mmt">4、sqluldr2</p>
                <p class="mmt">老楼开发的软件，基于OCI，使用非常方便，就是一个可执行文件配合参数命令，类似expdp等的命令行使用方法，支持自定义sql、本地和客户端的导出，效率非常高。</p>
                <p class="mmt">经过测试比较，本次使用sqluldr2。</p>
                <p class="mmt">使用方法如下：</p>
                <p class="mmt">（1）、获取工具</p>
                <p class="mmt">下载：http://www.onexsoft.com/software/sqluldr2linux64.zip,上传解压即可使用</p>
                <p class="mmt">（2）、工具的参数</p>
                <pre>user    = username/password@tnsname  
        sql     = SQL file name  
        query   = select statement  
        field   = separator string between fields  
        record  = separator string between records  
        rows    = print progress for every given rows (default, 1000000)   
        file    = output file name(default: uldrdata.txt)  
        log     = log file name, prefix with + to append mode  
        fast    = auto tuning the session level parameters(YES)  
        text    = output type (MYSQL, CSV, MYSQLINS, ORACLEINS, FORM, SEARCH).  
        charset = character set name of the target database.  
        ncharset= national character set name of the target database.  
        parfile = read command option from parameter file   
        read    = set DB_FILE_MULTIBLOCK_READ_COUNT at session level  
        sort    = set SORT_AREA_SIZE at session level (UNIT:MB)   
        hash    = set HASH_AREA_SIZE at session level (UNIT:MB)   
        array   = array fetch size  
        head    = print row header(Yes|No)  
        batch   = save to new file for every rows batch (Yes/No)  
        size    = maximum output file piece size (UNIB:MB)  
        serial  = set _serial_direct_read to TRUE at session level  
        trace   = set event 10046 to given level at session level  
        table   = table name in the sqlldr control file  
        control = sqlldr control file and path.  
        mode    = sqlldr option, INSERT or APPEND or REPLACE or TRUNCATE   
        buffer  = sqlldr READSIZE and BINDSIZE, default 16 (MB)  
        long    = maximum long field size  
        width   = customized max column width (w1:w2:...)   
        quote   = optional quote string   
        data    = disable real data unload (NO, OFF)   
        alter   = alter session SQLs to be execute before unload   
        safe    = use large buffer to avoid ORA-24345 error (Yes|No)   
        crypt   = encrypted user information only (Yes|No)   
        sedf/t  = enable character translation function   
        null    = replace null with given value   
        escape  = escape character for special characters  
        escf/t  = escape from/to characters list   
        format  = MYSQL: MySQL Insert SQLs, SQL: Insert SQLs.  
        exec    = the command to execute the SQLs.  
        prehead = column name prefix for head line.  
        rowpre  = row prefix string for each line.  
        rowsuf  = row sufix string for each line.  
        colsep  = separator string between column name and value.  
        presql  = SQL or scripts to be executed before data unload.  
        postsql = SQL or scripts to be executed after data unload.  
        lob     = extract lob values to single file (FILE).  
        lobdir  = subdirectory count to store lob files .  
        split   = table name for automatically parallelization.  
        degree  = parallelize data copy degree (2-128).  
 
        for field and record, you can use '0x' to specify hex character code,  
          \r=0x0d \n=0x0a |=0x7c ,=0x2c, \t=0x09, :=0x3a, #=0x23, "=0x22 '=0x27</span>   
</pre>
                <p class="mmt">（3）、执行导出</p>
                <p class="mmt">（3.1） sqluldr2的链接数据库</p>
                <p class="mmt">本地执行方式：users参数可以省略不写，和expdp username/passwd 方式一样</p>
                <code>export ORACLE_SID=orcl</code><br>
                <code>sqluldr2 testuser/testuser  query=test_table1 file=test_table1.txt</code>
                <p class="mmt">客户端连接：tns方式</p>
                <code>sqluldr2 testuser/testuser@orcl  query=test_table1 file=test_table1.txt</code>
                <p class="mmt">客户端连接：简易连接</p>
                <code>sqluldr2 testuser/testuser@x.x.x.x:1521/orcl  query=test_table1 file=test_table1.txt</code>
                <p class="mmt">（3.2） 要导出的数据由query控制</p>
                <p class="mmt">query参数如果整表导出，可以直接写表名，如果需要查询运算和where条件，query=“sql文本”，也可以把复杂sql写入到文本中由query调用。</p>
                <p class="mmt">（3.3） 分隔符设置</p>
                <p class="mmt">默认是逗号分隔符，通过field参数指定分隔符</p>
                <code>sqluldr2 testuser/testuser query=chen.tt1 field=";"</code>
                <p class="mmt">（3.4） 大数据量操作</p>
                <p class="mmt">对于大表可以输出到多个文件中，指定行数分割或者按照文件大小分割，例如：</p>
                <code>sqluldr2 testuser/testuser@orcl query="select * from test_table2" file=test_table2_%B.txt batch=yes rows=500000</code>
                <h6> 三、csv导入到MySQL</h6>
                <code>（1）load data local infile "D:/l_table.csv" ignore into table l_table character set utf8 fields terminated by ',' LINES TERMINATED BY '\n';</code>
                <p class="mmt">忽略错误、设置字符集utf8</p>
                <code>（2）load data local infile "D:/dt_data/l_table.csv" into table l_table character set GBK fields terminated by ',' LINES TERMINATED BY '\n';</code>
                <p class="mmt">表数据有中文的时候报错，将字符集设置为GBK可进行导入；</p>
                <code>（3）load data local infile "D:/dt_data/l_table.csv" into table l_table character set GBK fields terminated by ',' LINES TERMINATED BY '##';</code>
                <p class="mmt">数据存在特殊字符，可以指定行分隔符。前提是导出的时候采用的也是"##"分隔符</p>
                <h6> 四、实际操作</h6>
                <p class="mmt">单个CSV文件不宜太大，建议不要超过1GB。变数据量超过200万的建议分割，生成多个CSV文件；</p>
                <p class="mmt">表l_table实测：l_table表数据存在特殊字符，以##做为行分割符，导出数据</p>
                <code>sqluldr2 dt/********@ORCL query="select * from l_table" record=## head=no file=D:\dt_data\l_table.csv</code>
                <p class="mmt">注意，执行此命令时，控制台需要切换到sqluldr2的目录下执行。</p>
                <p class="mmt">导入数据：</p>
                <code>load data local infile "D:/dt_data/l_table.csv" into table lccont character set GBK fields terminated by ',' LINES TERMINATED BY '##';</code>
                <p class="mmt">执行此命令时需要控制台登录MySQL，选用需要导入的数据库，然后执行。</p>
              </p>
                

                <br>
                <br>
                <hr>
                <div class="centered">
                  <img src="../img/visual/messydraw05.gif" class="img-circle" width="80">
                  <p class="centered">谢谢！</p>
                </div>
              </div>

            </div>
          </div>
        </div>

      </section>
      <!-- /wrapper -->
    </section>
    <!-- /MAIN CONTENT -->
    <!--main content end-->

    <!--footer start-->
    <footer class="site-footer">
      <div class="text-center">
        <p style="font-size: 10px;">
          &copy; Copyrights <strong>Anwhere </strong>. All Rights Reserved
        </p>
        <div class="credits" style="font-size: 11px;">
          <!--
            You are NOT allowed to delete the credit link 
          -->
          Powered by <a href="https://github.com/">Github</a>
        </div>
        <a href="../index.html#" class="go-top">
          <i class="fa fa-angle-up"></i>
          </a>
      </div>
    </footer>
    <!--footer end-->
  </section>
  <!-- js placed at the end of the document so the pages load faster -->
  <script src="../lib/jquery/jquery.min.js"></script>
  
  <script src="../lib/bootstrap/js/bootstrap.min.js"></script>
  <script class="include" type="text/javascript" src="../lib/jquery.dcjqaccordion.2.7.js"></script>
  <script src="../lib/jquery.scrollTo.min.js"></script>
  <script src="../lib/jquery.nicescroll.js" type="text/javascript"></script>
  <!--common script for all pages-->
  <script src="../lib/common-scripts.js"></script>
  <!--script for this page-->
  <script type="text/javascript" src=".../lib/gritter/js/jquery.gritter.js"></script>
  <script type="text/javascript" src="../lib/gritter-conf.js"></script>
</body>

</html>
